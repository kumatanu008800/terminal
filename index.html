<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bloomberg Terminal LV400</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  color:#fff;
  font-family:"Courier New",monospace;
  height:100%;
}
body{display:flex;height:100dvh;overflow:hidden;}

#leftmenu{
  width:60px;
  min-width:60px;
  background:#070707;
  border-right:2px solid #ff8800;
  position:relative;
}
#bootdate{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  color:#ff8800;
  font-size:36px;
  letter-spacing:4px;
  writing-mode:vertical-rl;
  text-orientation:upright;
  white-space:nowrap;
  font-family:Arial,Helvetica,sans-serif;
}

#main{flex:1;display:flex;flex-direction:column;min-width:0;}

#topbar{
  height:60px;
  background:#111;
  border-bottom:2px solid #ff8800;
  display:flex;
  align-items:center;
  padding:0 20px;
}
#clock{color:#ff8800;font-size:28px;font-weight:bold;}

#pages{position:relative;flex:1;overflow:hidden;}

.page{
  position:absolute;inset:0;padding:20px;
  box-sizing:border-box;display:flex;gap:20px;
  opacity:0;visibility:hidden;pointer-events:none;
  transition:opacity .6s ease;
}
.page.active{opacity:1;visibility:visible;pointer-events:auto;}

.panel{
  flex:1;background:#050505;border:1px solid #222;
  padding:15px;box-sizing:border-box;
}

.bigFX{
  font-size:10vw;
  color:#ff8800;
  font-weight:bold;
  text-align:center;
  width:100%;
}

.priceFlashUp{
  color:#00ff66 !important;
  background:#002b00;
  box-shadow:0 0 16px #00ff66;
  transition:all .2s ease-out;
}

.priceFlashDown{
  color:#ff3333 !important;
  background:#2b0000;
  box-shadow:0 0 16px #ff3333;
  transition:all .2s ease-out;
}

/* ===== æ¡ã ã‘ç‚¹æ»… ===== */

.digitUp{
  color:#00ff66;
  background:#002b00;
  animation:digitFlash 0.4s ease;
}

.digitDown{
  color:#ff3333;
  background:#2b0000;
  animation:digitFlash 0.4s ease;
}

@keyframes digitFlash{
  0%{opacity:0.3;}
  100%{opacity:1;}
}


.fxChangeUp{color:#00ff66;}
.fxChangeDown{color:#ff3333;}

.updatedTime{
  font-size:14px;
  color:#ff8800;
  margin-top:10px;
}
.newsHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.newsTitle{
  color:#ff8800;
  font-size:18px;
  font-weight:bold;
}
canvas{
  background:#111;
  border:1px solid #ff8800;
  width:100%;
  height:300px;
}

.newsItem{border-bottom:1px solid #222;padding:6px 0;font-size:14px;}
.dailyItem{border-bottom:1px solid #222;padding:4px 0;font-size:14px;}


#ticker{
  height:50px;
  background:#111;
  border-top:2px solid #ff8800;
  overflow:hidden;
  position:relative;
}

#tickerTrack{
  display:flex;
  width:max-content;
  animation:tickerScroll linear infinite;
  animation-duration:60s; /* â† ä»®ã®åˆæœŸå€¤ */
}

.tickerContent{
  white-space:nowrap;
  padding-right:100px;
  color:#ff8800;
  font-weight:bold;
}

@keyframes tickerScroll{
  from{ transform:translateX(0); }
  to{ transform:translateX(-50%); }
}

@media (orientation: landscape){
  .page{flex-direction:column;overflow:auto;}
  canvas{height:250px;}
  .bigFX{font-size:6vw;}
}
</style>
</head>
<body>

<div id="leftmenu">
  <div id="bootdate"></div>
</div>

<div id="main">

<div id="topbar">
  <div id="clock">00:00:00</div>
</div>

<div id="pages">

<div id="page_clock" class="page active">
  <div class="panel" style="display:flex;align-items:center;justify-content:center;flex-direction:column;">

    <div class="bigFX">
      USD/JPY <span id="price">å–å¾—ä¸­â€¦</span>
    </div>

    <div id="fxInfo"></div>
    <div id="orukanInfo"></div>

    <div class="updatedTime" id="fxUpdated"></div>
    </div>
</div>
<div id="page_stock" class="page">
  <div class="panel">
    <div style="color:#ff8800;margin-bottom:10px;">
      MAXIS å…¨ä¸–ç•Œæ ªå¼ï¼ˆã‚ªãƒ¼ãƒ«ãƒ»ã‚«ãƒ³ãƒˆãƒªãƒ¼ï¼‰
    </div>

    <div id="ac_price">å–å¾—ä¸­â€¦</div>
    <div class="updatedTime" id="stockUpdated"></div>

    <canvas id="chart"></canvas>
  </div>
</div>

<div id="page_weather" class="page">
<div class="panel">
<div style="color:#ff8800;margin-bottom:10px;">
é€±é–“å¤©æ°—
</div>
<div id="weatherToday">å–å¾—ä¸­â€¦</div>
<div style="margin-top:10px;border-top:1px solid #222;padding-top:8px;" id="weatherWeekly"></div>
</div>
</div>

<!-- ç·åˆãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ -->
<div id="page_news_general" class="page">
  <div class="panel">
  <div class="newsHeader">
    <div class="newsTitle">ã€ç·åˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘</div>
    <div class="updatedTime" id="newsUpdatedGeneral"></div>
  </div>
  <div id="newsGeneral"></div>
</div>
</div>

<!-- çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ -->
<div id="page_news_economy" class="page">
  <div class="panel">
  <div class="newsHeader">
    <div class="newsTitle">ã€çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘</div>
    <div class="updatedTime" id="newsUpdatedEconomy"></div>
  </div>
  <div id="newsEconomy"></div>
</div>
</div>

</div>

<div id="ticker">
  <div id="tickerTrack">
    <div class="tickerContent" id="tickerText1"></div>
    <div class="tickerContent" id="tickerText2"></div>
  </div>
</div>
</div>

<script>
/* ===== DOMå–å¾— ===== */
const bootdate=document.getElementById("bootdate");
const clock=document.getElementById("clock");

const fxUpdated=document.getElementById("fxUpdated");
const ac_price=document.getElementById("ac_price");
const stockUpdated=document.getElementById("stockUpdated");
const weatherToday=document.getElementById("weatherToday");
const weatherWeekly=document.getElementById("weatherWeekly");
const newsGeneral=document.getElementById("newsGeneral");
const newsEconomy=document.getElementById("newsEconomy");
const newsUpdatedGeneral =
  document.getElementById("newsUpdatedGeneral");

const newsUpdatedEconomy =
  document.getElementById("newsUpdatedEconomy");
const tickerText1=document.getElementById("tickerText1");
const tickerText2=document.getElementById("tickerText2");
const tickerTrack = document.getElementById("tickerTrack");

function adjustTickerSpeed(){
  requestAnimationFrame(()=>{

    const width = tickerTrack.scrollWidth / 2;
    const speed = 80; // 80px/ç§’
    const duration = width / speed;

    tickerTrack.style.animationDuration = duration + "s";

  });
}
/* ===== å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ—¥ä»˜ ===== */
const now=new Date();
const week=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
bootdate.innerText=
 (now.getMonth()+1)+"æœˆ"+
 now.getDate()+"æ—¥"+
 "ï¼ˆ"+week[now.getDay()]+"ï¼‰";

/* ===== æ™‚è¨ˆ ===== */
function updateClock(){
 const n=new Date();
 clock.innerText=
  String(n.getHours()).padStart(2,"0")+":"+
  String(n.getMinutes()).padStart(2,"0")+":"+
  String(n.getSeconds()).padStart(2,"0");
}
setInterval(updateClock,1000);
updateClock();

function getNowTime(){
 const n=new Date();
 return String(n.getHours()).padStart(2,"0")+":"+
        String(n.getMinutes()).padStart(2,"0")+":"+
        String(n.getSeconds()).padStart(2,"0");
}

/* ===== ãƒšãƒ¼ã‚¸åˆ‡æ›¿ ===== */
const pages=[
  "page_clock",
  "page_stock",
  "page_weather",
  "page_news_general",
  "page_news_economy"
];
let pageIndex=0;
setInterval(()=>{
 document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
 pageIndex=(pageIndex+1)%pages.length;
 document.getElementById(pages[pageIndex]).classList.add("active");
 if(pages[pageIndex]==="page_stock" && chartData.length){drawChart();}
},80000);

/* ===== ãƒ†ã‚£ãƒƒã‚«ãƒ¼ ===== */
let tickerFX="",tickerStock="",tickerNews="";
function updateTicker(){
const fullText = tickerFX + tickerStock + tickerNews;
  tickerText1.innerHTML = fullText;
  tickerText2.innerHTML = fullText;

  adjustTickerSpeed(); // â† ã“ã®1è¡Œã‚’è¿½åŠ 

}
/* ===== USDJPY ç›´å‰æ›´æ–°æ¯” ===== */

let lastFX = null;
let baseFX = null; // èµ·å‹•æ™‚ãƒ¬ãƒ¼ãƒˆ

let simulatedFX = null;   // ç–‘ä¼¼è¡¨ç¤ºç”¨
let simulationTimer = null;
let previousDisplayPrice = null;

async function loadFX(){
  try{

    const res = await fetch(
      "https://open.er-api.com/v6/latest/USD",
      { cache:"no-store" }
    );

    const data = await res.json();
    if(!data.rates || !data.rates.JPY) throw "API error";

    const latest = data.rates.JPY;
    
    // APIå€¤ã‚’åŸºæº–ã«ã™ã‚‹
simulatedFX = latest;

// æ—¢å­˜ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
//if(simulationTimer){
//  clearInterval(simulationTimer);
//}

// ç–‘ä¼¼å¤‰å‹•ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆ1ç§’ã”ã¨ï¼‰
//simulationTimer = setInterval(simulateFXMove, 1000);
    

// èµ·å‹•æ™‚ãƒ¬ãƒ¼ãƒˆä¿å­˜
if(baseFX === null){
  baseFX = latest;
}

    let changeHTML = "";
    let tickerMove = "";

    if(lastFX !== null){

      const change = latest - lastFX;
      const percent = (change / lastFX) * 100;

      const up = change > 0;
      const down = change < 0;

      const color = up ? "#00ff66" :
                    down ? "#ff3333" :
                    "#ffffff";

      const arrow = up ? "â–²" :
                    down ? "â–¼" : "ï¼";

      changeHTML =
        `<span style="font-size:18px;color:${color}">
         å‰å›æ¯” ${change>=0?"+":""}${change.toFixed(3)}
         (${percent>=0?"+":""}${percent.toFixed(2)}%)
         </span>`;

      
    }

let sinceStartHTML = "";

if(baseFX !== null){

  const diffFromStart = latest - baseFX;
  const percentFromStart = (diffFromStart / baseFX) * 100;

  const up = diffFromStart > 0;
  const down = diffFromStart < 0;

  const color = up ? "#00ff66" :
                down ? "#ff3333" :
                "#ffffff";

  const arrow = up ? "â–²" :
                down ? "â–¼" : "ï¼";

  sinceStartHTML =
  `<br>
   <span style="font-size:18px;color:${color}">
   èµ·å‹•å¾Œ ${diffFromStart>=0?"+":""}${diffFromStart.toFixed(3)}
   (${percentFromStart>=0?"+":""}${percentFromStart.toFixed(2)}%)
   </span>`;
   
   tickerMove =
  `<span style="color:${color}">
   ${arrow}${Math.abs(diffFromStart).toFixed(3)}
   (${Math.abs(percentFromStart).toFixed(2)}%)
   </span>`;
   
}


  
/* ===== ã‚ªãƒ«ã‚«ãƒ³æ¨ç®—è¡¨ç¤º ===== */
if(orukanEstimated !== null){

  const up = orukanDiff > 0;
  const down = orukanDiff < 0;

  const color = up ? "#00ff66" :
                down ? "#ff3333" :
                "#ffffff";

  const arrow = up ? "â–²" :
                down ? "â–¼" : "ï¼";

  document.getElementById("orukanInfo").innerHTML =
  `<div class="bigFX">
     ã‚ªãƒ«ã‚«ãƒ³æ¨ç®— ${orukanEstimated.toFixed(0)}
   </div>
<div style="font-size:6vw;color:${color};font-weight:bold;text-align:center;width:100%;">
     ${arrow}${Math.abs(orukanDiff).toFixed(0)}
     (${Math.abs(orukanDiffPercent).toFixed(2)}%)
   </div>`;
}

const priceEl = document.getElementById("price");

if(priceEl && lastFX !== null){

  priceEl.classList.remove("priceFlashUp","priceFlashDown");

  if(latest > lastFX){
    priceEl.classList.add("priceFlashUp");
  }else if(latest < lastFX){
    priceEl.classList.add("priceFlashDown");
  }

  setTimeout(()=>{
    priceEl.classList.remove("priceFlashUp","priceFlashDown");
  },350);
}

const displayPrice =
  simulatedFX !== null
    ? simulatedFX.toFixed(3)
    : latest.toFixed(3);

document.getElementById("price").innerText = displayPrice;

tickerFX =
  `USD/JPY ${displayPrice} ${tickerMove}`;

    updateTicker();
    fxUpdated.innerText = "UPDATED " + getNowTime();

    lastFX = latest;

  }catch(e){
    console.error(e);
document.getElementById("price").innerText = "å–å¾—ã‚¨ãƒ©ãƒ¼";
    fxUpdated.innerText="ERROR "+getNowTime();
  }
}

function simulateFXMove(){

  if(simulatedFX === null) return;

  const prev = simulatedFX;

  const move = (Math.random() - 0.5) * 0.006;
  simulatedFX += move;

// èµ·å‹•æ™‚ã‹ã‚‰ã®å¤‰åŒ–ã«å¤‰æ›´
const change = simulatedFX - baseFX;
const percent = (change / baseFX) * 100;

  const up = change > 0;
  const down = change < 0;

  const color = up ? "#00ff66" :
                down ? "#ff3333" :
                "#ffffff";

  const arrow = up ? "â–²" :
                down ? "â–¼" : "ï¼";

  const priceEl = document.getElementById("price");

if(priceEl){

  const newPrice = simulatedFX.toFixed(3);

  if(previousDisplayPrice === null){
    priceEl.innerText = newPrice;
  }else{

    let html = "";

    for(let i=0;i<newPrice.length;i++){

      const newChar = newPrice[i];
      const oldChar = previousDisplayPrice[i];

      if(newChar !== oldChar && newChar !== "."){

html += `<span class="${
  simulatedFX > prev
    ? "digitUp"
    : "digitDown"
}">${newChar}</span>`;

      }else{
        html += newChar;
      }
    }

    priceEl.innerHTML = html;
  }

  previousDisplayPrice = newPrice;
}

  tickerFX =
    `USD/JPY ${simulatedFX.toFixed(3)}
     <span style="color:${color}">
     ${arrow}${Math.abs(change).toFixed(3)}
     (${Math.abs(percent).toFixed(3)}%)
     </span>`;

  updateTicker();
}

loadFX();
setInterval(loadFX,15000);

/* ===== æ ª ===== */
let chartData=[],lastLabels=[],volumeData=[];
/* ===== ã‚ªãƒ«ã‚«ãƒ³æ¨ç®—ç”¨ ===== */
/* ===== ã‚ªãƒ«ã‚«ãƒ³ä¿‚æ•°æ–¹å¼ ===== */
const ORUKAN_COEF = 1.275; // â† å›ºå®šä¿‚æ•°ï¼ˆã“ã‚Œã ã‘ï¼‰
let orukanEstimated = null;
let orukanDiff = null;
let orukanDiffPercent = null;
async function loadStock(){
 try{

  const url =
   "https://query2.finance.yahoo.com/v8/finance/chart/2559.T?range=1mo&interval=1d";

  const proxy =
   "https://corsproxy.io/?" + encodeURIComponent(url);

  const res = await fetch(proxy, {
    cache: "no-store"
  });

  if(!res.ok) throw "HTTP ERROR";

  const json = await res.json();
  if(!json.chart?.result?.[0]) throw "DATA ERROR";

  const result = json.chart.result[0];

  const rawPrices =
    result.indicators.adjclose[0].adjclose;

  const rawTimes =
    result.timestamp;

  const rawVolume =
    result.indicators.quote[0].volume;

  const filtered = rawPrices
    .map((p,i)=>({
      price:p,
      time:rawTimes[i],
      volume:rawVolume[i]
    }))
    .filter(v=>v.price!==null && v.volume!==null)
    .slice(-7);

  const prices  = filtered.map(v=>v.price);
  const times   = filtered.map(v=>v.time);
  const volumes = filtered.map(v=>v.volume);

  if(prices.length < 2) throw "NOT ENOUGH DATA";

  lastLabels = times.map(t=>{
    const d=new Date(t*1000);
    return (d.getMonth()+1)+"/"+d.getDate();
  });

  const latest = prices.at(-1);
  const prev   = prices.at(-2);
/* ===== ä¸Šç´šç‰ˆâ‘  3æ—¥å¹³å‡å¤‰åŒ–ç‡æ–¹å¼ ===== */



/* ===== æ¨ç®— ===== */

orukanEstimated = latest * ORUKAN_COEF;

const prevOrukan = prev * ORUKAN_COEF;

orukanDiff = orukanEstimated - prevOrukan;

orukanDiffPercent =
  (orukanDiff / prevOrukan) * 100;
  
  /* ===== è‡ªå·±å­¦ç¿’å‹ ä¿‚æ•°å¾®èª¿æ•´ ===== */


// ä»Šæ—¥ã®æ¨ç®—å€¤ã‚’ä¿å­˜

  const change = ((latest - prev) / prev) * 100;

  ac_price.innerHTML =
    latest.toFixed(0)+" å†† "+
    "<span style='color:"+(change>=0?"#00ff66":"#ff3333")+"'>"+
    (change>=0?"+":"")+change.toFixed(2)+"%</span>";

  stockUpdated.innerText =
    "UPDATED "+getNowTime();

  tickerStock =
    `2559.T ${latest.toFixed(0)}
     <span style="color:${change>=0?"#00ff66":"#ff3333"}">
     ${change>=0?"â–²":"â–¼"}${Math.abs(change).toFixed(2)}%</span>`;

if(orukanEstimated !== null){

  tickerStock +=
    ` â—† ï½µï¾™ï½¶ï¾æ¨ç®— ${orukanEstimated.toFixed(0)}
     <span style="color:${orukanDiff>=0?"#00ff66":"#ff3333"}">
     ${orukanDiff>=0?"â–²":"â–¼"}${Math.abs(orukanDiffPercent).toFixed(2)}%</span>`;
}

  updateTicker();

  chartData = prices;
  volumeData = volumes;

  setTimeout(()=>drawChart(),50);

 }catch(e){
  console.error(e);
  ac_price.innerText="æ ªä¾¡å–å¾—ã‚¨ãƒ©ãƒ¼";
  stockUpdated.innerText="ERROR "+getNowTime();
 }
}

function drawChart(){
 if(chartData.length<2) return;
 const c=document.getElementById("chart");
 const ctx=c.getContext("2d");

 const dpr=window.devicePixelRatio||1;
 ctx.setTransform(1,0,0,1,0,0);
 c.width=c.clientWidth*dpr;
 c.height=c.clientHeight*dpr;
 ctx.scale(dpr,dpr);

 ctx.clearRect(0,0,c.width,c.height);

const padding=60;
const w=c.clientWidth-padding*2;

const totalHeight=c.clientHeight-padding*2;
const priceHeight=totalHeight*0.7;
const volumeHeight=totalHeight*0.3;

 const rawMax=Math.max(...chartData);
 const rawMin=Math.min(...chartData);

 const paddingRange=(rawMax-rawMin)*0.1;
 const max=rawMax+paddingRange;
 const min=rawMin-paddingRange;
 const range=max-min||1;

 ctx.fillStyle="#ff8800";
 ctx.font="12px Courier New";

 for(let i=0;i<=4;i++){
  const val=min+range*(i/4);
 const y=padding+priceHeight-(priceHeight*(i/4));
  ctx.strokeStyle="#222";
  ctx.beginPath();ctx.moveTo(padding,y);ctx.lineTo(c.clientWidth-padding,y);ctx.stroke();
  ctx.fillText(val.toFixed(0),10,y+4);
 }

 const gap=w/(chartData.length-1);
 lastLabels.forEach((lab,i)=>{
  const x=padding+i*gap;
  ctx.strokeStyle="#222";
  ctx.beginPath();ctx.moveTo(x,padding);ctx.lineTo(x,c.clientHeight-padding);ctx.stroke();
  ctx.fillText(lab,x-15,c.clientHeight-20);
 });

 ctx.strokeStyle="#ff8800";
 ctx.beginPath();
chartData.forEach((v,i)=>{
  const x = padding + i*gap;   // â† è¿½åŠ 
  const y =
    padding + priceHeight
    - ((v-min)/range)*priceHeight;

  if(i===0) ctx.moveTo(x,y);
  else ctx.lineTo(x,y);
});
 ctx.stroke();
 /* ===== å‡ºæ¥é«˜ãƒãƒ¼æç”» ===== */

const maxVolume=Math.max(...volumeData);

volumeData.forEach((vol,i)=>{

  const barWidth=gap*0.6;
  const x=padding+i*gap-barWidth/2;

  const barHeight=
    (vol/maxVolume)*volumeHeight;

  const y=
    padding+priceHeight
    + (volumeHeight-barHeight);

  // ä¸Šæ˜‡ãƒ»ä¸‹è½è‰²åˆ†ã‘
  if(i>0 && chartData[i]>=chartData[i-1]){
    ctx.fillStyle="#00aa55";
  }else{
    ctx.fillStyle="#aa3333";
  }

  ctx.fillRect(x,y,barWidth,barHeight);
});
 
}

window.addEventListener("resize",()=>drawChart());
loadStock();
setInterval(loadStock,60000);

/* ===== å¤©æ°—ï¼ˆGPSå¯¾å¿œï¼‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ===== */

function getWeatherIcon(code){
 if(code===0)return"â˜€ï¸";
 if(code===1)return"ğŸŒ¤";
 if(code===2)return"â›…";
 if(code===3)return"â˜ï¸";
 if(code>=45 && code<=48)return"ğŸŒ«";
 if(code>=51 && code<=57)return"ğŸŒ¦";
 if(code>=61 && code<=67)return"ğŸŒ§";
 if(code>=71 && code<=77)return"â„ï¸";
 if(code>=80 && code<=82)return"ğŸŒ§";
 if(code>=95)return"â›ˆ";
 return"â˜ï¸";
}

async function loadWeather(){

  if(!navigator.geolocation){
    loadDefaultWeather();
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos=>{
      loadWeatherByCoords(
        pos.coords.latitude,
        pos.coords.longitude,
        "ç¾åœ¨åœ°ï¼ˆä½ç²¾åº¦ï¼‰"
      );
    },
    ()=>{
      loadDefaultWeather();
    }
  );
}

function loadDefaultWeather(){
  // å¥ˆè‰¯çœŒç”Ÿé§’å¸‚ã‚ã™ã‹é‡å—
  loadWeatherByCoords(
    34.69,
    135.70,
    "å¥ˆè‰¯çœŒç”Ÿé§’å¸‚ã‚ã™ã‹é‡å—"
  );
}

async function loadWeatherByCoords(lat,lon,label){

 try{

  const url =
   `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo`;

  const res=await fetch(url);
  const j=await res.json();

  const week=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];

  const todayDate=new Date(j.daily.time[0]);
  const todayLabel=
   (todayDate.getMonth()+1)+"/"+
   todayDate.getDate()+
   "ï¼ˆ"+week[todayDate.getDay()]+"ï¼‰";

  weatherToday.innerHTML=
   `${label}<br>
   <span style="font-size:2.2em;">${getWeatherIcon(j.daily.weathercode[0])}</span> ${todayLabel}<br>
   æœ€é«˜æ°—æ¸© ${j.daily.temperature_2m_max[0]}â„ƒ<br>
   æœ€ä½æ°—æ¸© ${j.daily.temperature_2m_min[0]}â„ƒ<br>
   é™æ°´ç¢ºç‡ ${j.daily.precipitation_probability_max[0]}%`;

  let wk="";
  for(let i=1;i<7;i++){
   const d=new Date(j.daily.time[i]);
   const label2=
    (d.getMonth()+1)+"/"+
    d.getDate()+
    "ï¼ˆ"+week[d.getDay()]+"ï¼‰";

   wk+=`<div class='dailyItem'>
   ${getWeatherIcon(j.daily.weathercode[i])}
   ${label2}
   ${j.daily.temperature_2m_max[i]}â„ƒ /
   ${j.daily.temperature_2m_min[i]}â„ƒ
   ${j.daily.precipitation_probability_max[i]}%
   </div>`;
  }
  weatherWeekly.innerHTML=wk;

 }catch(e){
  weatherToday.innerText="å¤©æ°—å–å¾—ã‚¨ãƒ©ãƒ¼";
 }
}

loadWeather();
setInterval(loadWeather,3600000);

/* ===== ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼ˆå®Œå…¨åˆ†é›¢å‹ãƒ—ãƒ­ä»•æ§˜ï¼‰ ===== */

const alertWords = [
  "æ—¥éŠ€","å††å®‰","å††é«˜","åˆ©ä¸Šã’","åˆ©ä¸‹ã’",
  "æ ªå®‰","æ ªé«˜","ç‚ºæ›¿ä»‹å…¥","ã‚¤ãƒ³ãƒ•ãƒ¬",
  "ç±³å›½","FRB","é›‡ç”¨çµ±è¨ˆ","CPI","GDP",
  "FOMC","é•·æœŸé‡‘åˆ©","10å¹´å‚µ","ãƒ‰ãƒ«å††",
  "ç‚ºæ›¿","æ”¿ç­–é‡‘åˆ©","å›ºå®šé‡‘åˆ©","å¤‰å‹•é‡‘åˆ©",
"ä½å®…ãƒ­ãƒ¼ãƒ³","é‡‘åˆ©ä¸Šæ˜‡","é‡‘åˆ©å¼•ãä¸Šã’",
"é‡‘åˆ©å¼•ãä¸‹ã’","ç ´ç¶»","æŒ‡æ•°","ç±³","æ—¥æœ¬",
"çŸ­æœŸé‡‘åˆ©","å¤‰å‹•é‡‘åˆ©","æ—¥ç±³","éŠ€è¡Œ"
];

function highlightWords(text){
  alertWords.forEach(word=>{
    const reg = new RegExp(word,"g");
    text = text.replace(
      reg,
      `<span style="color:#ff3333;font-weight:bold;">${word}</span>`
    );
  });
  return text;
}

async function loadNews(){

  const generalURL =
   "https://api.rss2json.com/v1/api.json?rss_url=https://www.nhk.or.jp/rss/news/cat0.xml";

  const economyURL =
   "https://api.rss2json.com/v1/api.json?rss_url=https://www.nhk.or.jp/rss/news/cat5.xml";

  let generalItems = [];
  let economyItems = [];

  /* ===== ç·åˆãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾— ===== */
  try{
    const res = await fetch(generalURL);
    if(res.ok){
      const json = await res.json();
      if(Array.isArray(json.items)){
        generalItems = json.items;
      }
    }
  }catch(e){
    console.log("General news failed:", e);
  }

  /* ===== çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾— ===== */
  try{
    const res = await fetch(economyURL);
    if(res.ok){
      const json = await res.json();
      if(Array.isArray(json.items)){
        economyItems = json.items;
      }
    }
  }catch(e){
    console.log("Economy news failed:", e);
  }

  /* ===== æç”»å‡¦ç† ===== */
    /* ===== æç”»å‡¦ç† ===== */

  newsGeneral.innerHTML = "";
  newsEconomy.innerHTML = "";

  let tickerCombined = "";

  /* --- ç·åˆ --- */
  if(generalItems.length){
    generalItems.slice(0,4).forEach(n=>{
      newsGeneral.innerHTML +=
        `<div class="newsItem">â–¶ ${highlightWords(n.title)}</div>`;
      tickerCombined += " â—† " + n.title;
    });
  }else{
    newsGeneral.innerHTML =
      `<div class="newsItem">ç·åˆãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—å¤±æ•—</div>`;
  }

  /* --- çµŒæ¸ˆ --- */
  if(economyItems.length){
    economyItems.slice(0,4).forEach(n=>{
      newsEconomy.innerHTML +=
        `<div class="newsItem">ğŸ’¹ ${highlightWords(n.title)}</div>`;
      tickerCombined += " â—† " + n.title;
    });
  }else{
    newsEconomy.innerHTML =
      `<div class="newsItem">çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—å¤±æ•—</div>`;
  }

  tickerNews = tickerCombined;
  updateTicker();
 newsUpdatedGeneral.innerText =
  "UPDATED " + getNowTime() ;

newsUpdatedEconomy.innerText =
  "UPDATED " + getNowTime(); 
}

loadNews();
setInterval(loadNews,300000);

</script>
</body>
</html>
