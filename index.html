<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bloomberg Terminal LV400</title>

<style>
html,body{
  margin:0;
  padding:0;
background:#0a0a0a;
color:#e6e6e6;
font-family:Arial,Helvetica,sans-serif;
  height:100%;
}
body{display:flex;height:100dvh;overflow:hidden;}

#leftmenu{
  width:60px;
  min-width:60px;
background:#0f0f0f;
border-right:2px solid #ff9900;
  position:relative;
}
#bootdate{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  color:#ff9900;
  font-size:36px;
  letter-spacing:4px;
  writing-mode:vertical-rl;
  text-orientation:upright;
  white-space:nowrap;
  font-family:Arial,Helvetica,sans-serif;
}

#main{flex:1;display:flex;flex-direction:column;min-width:0;}

#topbar{
  height:60px;
background:#141414;
border-bottom:2px solid #ff9900;
  display:flex;
  align-items:center;
  padding:0 20px;
}
#clock{color:#ff9900;font-size:34px;font-weight:bold;}

#bootTime{
  margin-left:auto;
  color:#666;
  font-size:14px;
  font-weight:bold;
  opacity:0.5;
}

#pages{position:relative;flex:1;overflow:hidden;}

.page{
  position:absolute;inset:0;padding:20px;
  box-sizing:border-box;display:flex;gap:20px;
  opacity:0;visibility:hidden;pointer-events:none;
  transition:opacity .6s ease;
}
.page.active{opacity:1;visibility:visible;pointer-events:auto;}

.panel{
  flex:1;background:#050505;border:0px solid #222;
  padding:15px;box-sizing:border-box;
  min-height:0;
}

.bigFX{
  font-size:10vw;
  color:#ff9900;
  font-weight:bold;
  text-align:center;
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;   /* â† ã“ã‚ŒãŒè¶…é‡è¦ */
}
.bigOrukan{
  font-size:10vw;
  font-weight:bold;
  text-align:center;
  width:100%;
  color:#ff9900;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;   /* â† ã“ã‚Œã‚’è¿½åŠ  */
}

.fxChange,
.orukanChange span{
  font-size:clamp(36px, 5vw, 64px);
  font-weight:bold;
}

.fxPanel{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  min-height:0;   /* â† ã“ã‚Œè¿½åŠ  */
}

.priceFlashUp{
  color:#00ff00 !important;
  text-shadow:0 0 12px rgba(0,255,0,0.8);
  transition:all .2s ease-out;
}

.priceFlashDown{
  color:#ff0000 !important;
  text-shadow:0 0 12px rgba(255,0,0,0.8);
  transition:all .2s ease-out;
}

/* ===== æ¡ã ã‘ç‚¹æ»… ===== */

.digitUp{
  color:#00ff00;
  text-shadow:0 0 10px rgba(0,255,0,0.9);
  animation:digitFlash 0.4s ease;
}

.digitDown{
  color:#ff0000;
  text-shadow:0 0 10px rgba(255,0,0,0.9);
  animation:digitFlash 0.4s ease;
}

@keyframes digitFlash{
  0%{opacity:0.3; transform:scale(1.05);}
  100%{opacity:1; transform:scale(1);}
}


.fxChangeUp{color:#00ff00;}
.fxChangeDown{color:#ff0000;}

.updatedTime{
  font-size:14px;
  color:#ff9900;
  margin-top:10px;
}
.newsHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.newsTitle{
  color:#ff9900;
  font-size:18px;
  font-weight:bold;
}
canvas{
  background:#111;
  border:1px solid #ff9900;
  width:100%;
  height:300px;
}

#fxChart{
  height:300px !important;
  max-height:300px;
  flex-shrink:0;
}

.newsItem{border-bottom:1px solid #222;padding:6px 0;font-size:14px;}
.dailyItem{border-bottom:1px solid #222;padding:4px 0;font-size:14px;}


#ticker{
  height:50px;
  background:#111;
  border-top:2px solid #ff9900;
  overflow:hidden;
  position:relative;
}

#tickerTrack{
  display:flex;
  width:max-content;
  animation:tickerScroll linear infinite;
  animation-duration:60s; /* â† ä»®ã®åˆæœŸå€¤ */
}

.tickerContent{
  white-space:nowrap;
  padding-right:100px;
  color:#ff9900;
  font-weight:bold;
  font-size:34px;   /* â† ã“ã“ã‚’è¿½åŠ ï¼ˆä»Šã®ç´„2å€ï¼‰ */
}

@keyframes tickerScroll{
  from{ transform:translateX(0); }
  to{ transform:translateX(-50%); }
}

@media (orientation: portrait){
  #fxChart{
    height:25vh !important;
    max-height:240px;
  }
  
  
.fxChange span{
  letter-spacing:1px;
}
  
}

@media (orientation: landscape){

/* ===== æ¨ªç”»é¢ ãƒ‹ãƒ¥ãƒ¼ã‚¹æ–‡å­—æ‹¡å¤§ ===== */
.newsItem{
  font-size:17px;  /* 14px Ã— 1.2 = ç´„16.8px */
}


  .page{
    flex-direction:column;
    overflow:auto;
  }

  #pages{
    height:calc(100dvh - 110px);
  }

.fxChange span{
  letter-spacing:1px;
}

  .panel{
    flex:1;
    min-height:0;
    overflow:hidden;
  }

  /* æœ¬ä½“ä¾¡æ ¼ */
  .bigFX,
  .bigOrukan{
    font-size:5.1vmin;
  }

  /* %è¡¨ç¤º */
  .fxChange,
  .orukanChange span{
    font-size:4.6vmin;
  }

  /* ãƒ­ãƒ¼ã‚½ã‚¯è¶³ */
  #fxChart{
    height:25.5vh !important;
    max-height:none !important;
  }
  
   .bigFX{
    gap:0.1px;  /* 10px â†’ 2px ã«åœ§ç¸® */
  }

  /* æ¨ç®—ã‚ªãƒ«ã‚«ãƒ³ã¨ % ã®é–“ */
  .bigOrukan{
    gap:0.1px; 
   }
  
  .fxChange,
  .orukanChange span{
    line-height:1.0;
  }
  
   /* æ¨ç®—ã‚ªãƒ«ã‚«ãƒ³ % ã¨ UPD ã®é–“ */
  .updatedTime{
    margin-top:0.1px;   /* 10px â†’ åŠåˆ† */
    font-size:3.5vmin;
  }
  
    #page_stock #chart{
    height:38vh !important;   /* â† å®‰å®šã™ã‚‹ */
    max-height:none !important;
  }

  /* 2ãƒšãƒ¼ã‚¸ç›® ã‚¿ã‚¤ãƒˆãƒ«ã¨ä¾¡é¡ã®é–“ã‚’åœ§ç¸® */
  #page_stock .panel > div:first-child{
    margin-bottom:0.1px !important;  
}

/* ===== æ¨ªç”»é¢ å¤©æ°—2ã‚«ãƒ©ãƒ åŒ– ===== */
#page_weather .panel{
  display:flex;
  gap:1px;
}

#weatherToday{
  flex:1;
}

#weatherWeekly{
  flex:1;
  margin-top:0 !important;
  border-top:none !important;
  padding-top:0 !important;
}

  #bootdate{
    top:53%;   /* â† 50% â†’ 55% ã«ä¸‹ã’ã‚‹ */
}


}
</style>
</head>
<body>

<div id="leftmenu">
  <div id="bootdate"></div>
</div>

<div id="main">

<div id="topbar">
  <div id="clock">00:00:00</div>
  <div id="bootTime"></div>
</div>

<div id="pages">

<div id="page_clock" class="page active">
<div class="panel fxPanel">
  
  <canvas id="fxChart"></canvas>

<div class="bigFX">
  <div>USD/JPY <span id="price">å–å¾—ä¸­â€¦</span></div>
  <div id="fxInfo"></div>
</div>

<div class="bigOrukan" id="orukanInfo">
  <div class="orukanPrice"></div>
  <div class="orukanChange"></div>
</div>

<div class="updatedTime" id="fxUpdated"></div>
    </div>
</div>
<div id="page_stock" class="page">
  <div class="panel">
    <div style="color:#ff9900;margin-bottom:10px;">
      MAXIS å…¨ä¸–ç•Œæ ªå¼ï¼ˆã‚ªãƒ¼ãƒ«ãƒ»ã‚«ãƒ³ãƒˆãƒªãƒ¼ï¼‰
    </div>

    <div id="ac_price">å–å¾—ä¸­â€¦</div>
    <div class="updatedTime" id="stockUpdated"></div>

    <canvas id="chart"></canvas>
  </div>
</div>

<div id="page_weather" class="page">
<div class="panel">
<div style="color:#ff9900;margin-bottom:10px;">
é€±é–“å¤©æ°—
</div>
<div id="weatherToday">å–å¾—ä¸­â€¦</div>
<div style="margin-top:10px;border-top:1px solid #222;padding-top:8px;" id="weatherWeekly"></div>
</div>
</div>

<!-- ç·åˆãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ -->
<div id="page_news_general" class="page">
  <div class="panel">
  <div class="newsHeader">
    <div class="newsTitle">ã€ç·åˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘</div>
    <div class="updatedTime" id="newsUpdatedGeneral"></div>
  </div>
  <div id="newsGeneral"></div>
</div>
</div>

<!-- çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ -->
<div id="page_news_economy" class="page">
  <div class="panel">
  <div class="newsHeader">
    <div class="newsTitle">ã€çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘</div>
    <div class="updatedTime" id="newsUpdatedEconomy"></div>
  </div>
  <div id="newsEconomy"></div>
</div>
</div>

</div>

<div id="ticker">
  <div id="tickerTrack">
    <div class="tickerContent" id="tickerText1"></div>
    <div class="tickerContent" id="tickerText2"></div>
  </div>
</div>
</div>

<script>
/* ===== DOMå–å¾— ===== */
const bootdate=document.getElementById("bootdate");
const clock=document.getElementById("clock");

const bootTimeEl = document.getElementById("bootTime");

const bootNow = new Date();
bootTimeEl.innerText =
  "LOG " +
  String(bootNow.getHours()).padStart(2,"0")+":"+
  String(bootNow.getMinutes()).padStart(2,"0")+":"+
  String(bootNow.getSeconds()).padStart(2,"0");


const fxUpdated=document.getElementById("fxUpdated");
const ac_price=document.getElementById("ac_price");
const stockUpdated=document.getElementById("stockUpdated");
const weatherToday=document.getElementById("weatherToday");
const weatherWeekly=document.getElementById("weatherWeekly");
const newsGeneral=document.getElementById("newsGeneral");
const newsEconomy=document.getElementById("newsEconomy");
const newsUpdatedGeneral =
  document.getElementById("newsUpdatedGeneral");

const newsUpdatedEconomy =
  document.getElementById("newsUpdatedEconomy");
const tickerText1=document.getElementById("tickerText1");
const tickerText2=document.getElementById("tickerText2");
const tickerTrack = document.getElementById("tickerTrack");

function adjustTickerSpeed(){
  requestAnimationFrame(()=>{

    const width = tickerTrack.scrollWidth / 2;
    const speed = 80; // 80px/ç§’
    const duration = width / speed;

    tickerTrack.style.animationDuration = duration + "s";

  });
}
/* ===== å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ—¥ä»˜ ===== */
/* ===== å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ—¥ä»˜ï¼ˆè‡ªå‹•æ›´æ–°ï¼‰ ===== */
const week=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];

function updateBootDate(){
  const now = new Date();
  bootdate.innerText =
    (now.getMonth()+1)+"æœˆ"+
    now.getDate()+"æ—¥"+
    "ï¼ˆ"+week[now.getDay()]+"ï¼‰";
}

// 60åˆ†ã”ã¨ã«æ›´æ–°ï¼ˆååˆ†è»½ã„ï¼‰
setInterval(updateBootDate,60000);

// èµ·å‹•æ™‚ã«ã‚‚å®Ÿè¡Œ
updateBootDate();

/* ===== æ™‚è¨ˆ ===== */
function updateClock(){
 const n=new Date();
 clock.innerText=
  String(n.getHours()).padStart(2,"0")+":"+
  String(n.getMinutes()).padStart(2,"0")+":"+
  String(n.getSeconds()).padStart(2,"0");
}
setInterval(updateClock,1000);
updateClock();

function getNowTime(){
 const n=new Date();
 return String(n.getHours()).padStart(2,"0")+":"+
        String(n.getMinutes()).padStart(2,"0")+":"+
        String(n.getSeconds()).padStart(2,"0");
}

/* ===== ãƒšãƒ¼ã‚¸åˆ‡æ›¿ ===== */
const pages=[
  "page_clock",
  "page_stock",
  "page_weather",
  "page_news_general",
  "page_news_economy"
];
let pageIndex=0;
setInterval(()=>{
 document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
 pageIndex=(pageIndex+1)%pages.length;
 document.getElementById(pages[pageIndex]).classList.add("active");

 if(pages[pageIndex]==="page_clock"){
   loadFX();   // â† â˜…ã“ã‚Œã‚’è¿½åŠ 
 }

 if(pages[pageIndex]==="page_stock" && chartData.length){
   drawChart();
 }

},70000);

/* ===== ãƒ†ã‚£ãƒƒã‚«ãƒ¼ ===== */
let tickerFX="",tickerStock="",tickerNews="";
function updateTicker(){
const fullText = tickerFX + tickerStock + tickerNews;
  tickerText1.innerHTML = fullText;
  tickerText2.innerHTML = fullText;

  adjustTickerSpeed(); // â† ã“ã®1è¡Œã‚’è¿½åŠ 

}
/* ===== USDJPY ç›´å‰æ›´æ–°æ¯” ===== */

let lastFX = null;
let lastTickerFX = null;
let lastTickerOrukan = null;
let baseFX = null; // èµ·å‹•æ™‚ãƒ¬ãƒ¼ãƒˆ



async function loadFX(){
  try{

    const baseURL =
      "https://query2.finance.yahoo.com/v8/finance/chart/USDJPY=X?range=1d&interval=1m";

const proxy =
  "https://corsproxy.io/?" +
  encodeURIComponent(baseURL) +
  "&t=" + Date.now();

    const res = await fetch(proxy,{cache:"no-store"});
    if(!res.ok) throw "HTTP ERROR";

    const data = await res.json();

    if(!data.chart?.result?.[0])
      throw "DATA ERROR";

    const result = data.chart.result[0];

    const closes =
      result.indicators.quote[0].close;
      
      const quotes = result.indicators.quote[0];
const opens  = quotes.open;
const highs  = quotes.high;
const lows   = quotes.low;
const closesAll = quotes.close;

drawFXCandle(opens, highs, lows, closesAll);

    const latest =
      closes.filter(v=>v!==null).at(-1);

    if(!latest) throw "PRICE ERROR";
    
// â˜… èµ·å‹•æ™‚ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ï¼ˆåˆå›ã®ã¿ï¼‰
if(baseFX === null){
  baseFX = latest;
}

    /* ===== è¡¨ç¤º ===== */

    const displayPrice =
      Number(latest).toFixed(3);   // â† ä¸­å¤®è¡¨ç¤ºï¼ˆç¬¬2ä½ï¼‰

    const tickerPrice =
      Number(latest).toFixed(3);   // â† ãƒ†ã‚£ãƒƒã‚«ãƒ¼ç”¨ï¼ˆç¬¬3ä½ï¼‰

    const priceEl = document.getElementById("price");

if(lastFX === null){
  priceEl.innerText = displayPrice;
}else{

  let html = "";

  const prevPrice = lastFX.toFixed(3);

let diffIndex = -1;

// æœ€åˆã«å¤‰ã‚ã£ãŸæ¡ã‚’æ¢ã™
for(let i=0;i<displayPrice.length;i++){
  if(displayPrice[i] !== prevPrice[i] &&
     displayPrice[i] !== "."){
    diffIndex = i;
    break;
  }
}

for(let i=0;i<displayPrice.length;i++){

  const newChar = displayPrice[i];

  // å¤‰åŒ–ã—ãŸæ¡ä»¥é™ã™ã¹ã¦ã‚’å…‰ã‚‰ã›ã‚‹
  if(diffIndex !== -1 &&
     i >= diffIndex &&
     newChar !== "."){

    html += `<span class="${
      latest > lastFX ? "digitUp" : "digitDown"
    }">${newChar}</span>`;

  }else{
    html += newChar;
  }
}

  priceEl.innerHTML = html;
}

lastFX = latest;

const diff = latest - baseFX;
const percent = (diff / baseFX) * 100;

const up = diff > 0;
const down = diff < 0;

const color = up ? "#00ff00" :
              down ? "#ff0000" :
              "#e6e6e6";

const arrow = up ? "â–²" :
              down ? "â–¼" : "ï¼";

let tickerPriceHTML = tickerPrice;

if(lastTickerFX !== null){

  const prev = lastTickerFX.toFixed(3);
  let html = "";
  let diffIndex = -1;

  // æœ€åˆã«å¤‰ã‚ã£ãŸæ¡ã‚’æ¢ã™
  for(let i=0;i<tickerPrice.length;i++){
    if(tickerPrice[i] !== prev[i] &&
       tickerPrice[i] !== "."){
      diffIndex = i;
      break;
    }
  }

  for(let i=0;i<tickerPrice.length;i++){

    const newChar = tickerPrice[i];

    if(diffIndex !== -1 &&
       i >= diffIndex &&
       newChar !== "."){

      html += `<span class="${
        latest > lastTickerFX
          ? "digitUp"
          : "digitDown"
      }">${newChar}</span>`;

    }else{
      html += newChar;
    }
  }

  tickerPriceHTML = html;
}

lastTickerFX = latest;

tickerFX =
  `USD/JPY ${tickerPriceHTML}
   <span style="color:${color}">
   ${arrow}${Math.abs(percent).toFixed(2)}%
   </span> â—† `;

document.getElementById("fxInfo").innerHTML =
  `<span class="fxChange" style="color:${color};">
    ${arrow}${Math.abs(percent).toFixed(2)}%
   </span>`;

/* ===== â˜…ã“ã“ã«è¿½åŠ ã™ã‚‹ ===== */




    fxUpdated.innerText =
      "UPD " + getNowTime();
      


updateTicker(); 

  }catch(e){
    console.error(e);
    document.getElementById("price")
      .innerText = "å–å¾—ã‚¨ãƒ©ãƒ¼";
    fxUpdated.innerText =
      "ERROR " + getNowTime();
  }
}



loadFX();
setInterval(loadFX,10000);


/* ===== æ ª ===== */
let chartData=[],lastLabels=[],volumeData=[];
/* ===== ã‚ªãƒ«ã‚«ãƒ³æ¨ç®—ç”¨ ===== */
/* ===== ã‚ªãƒ«ã‚«ãƒ³ä¿‚æ•°æ–¹å¼ ===== */
const ORUKAN_COEF = 1.275; // â† å›ºå®šä¿‚æ•°ï¼ˆã“ã‚Œã ã‘ï¼‰

let lastOrukan = null;   // â† â˜…ã“ã‚Œã‚’è¿½åŠ 

let orukanEstimated = null;
let orukanDiff = null;
let orukanDiffPercent = null;
async function loadStock(){
 try{

  const url =
   "https://query2.finance.yahoo.com/v8/finance/chart/2559.T?range=1mo&interval=1d";

  const proxy =
   "https://corsproxy.io/?" + encodeURIComponent(url);

  const res = await fetch(proxy, {
    cache: "no-store"
  });

  if(!res.ok) throw "HTTP ERROR";

  const json = await res.json();
  if(!json.chart?.result?.[0]) throw "DATA ERROR";

  const result = json.chart.result[0];

  const rawPrices =
    result.indicators.adjclose[0].adjclose;

  const rawTimes =
    result.timestamp;

  const rawVolume =
    result.indicators.quote[0].volume;

/* ===== è¡¨ç¤ºæ—¥æ•°ã‚’æ¡ä»¶åˆ†å² ===== */
/* ===== è¡¨ç¤ºæ—¥æ•°ã‚’æ¡ä»¶åˆ†å²ï¼ˆå®‰å®šç‰ˆï¼‰ ===== */

/* ===== è¡¨ç¤ºæ—¥æ•°ã‚’æ¡ä»¶åˆ†å²ï¼ˆå®Œæˆç‰ˆï¼‰ ===== */

const displayDays = 20;

const filtered = rawPrices
  .map((p,i)=>({
    price:p,
    time:rawTimes[i],
    volume:rawVolume[i]
  }))
  .filter(v=>v.price!==null && v.volume!==null)
  .slice(-displayDays);

  const prices  = filtered.map(v=>v.price);
  const times   = filtered.map(v=>v.time);
  const volumes = filtered.map(v=>v.volume);

  if(prices.length < 2) throw "NOT ENOUGH DATA";

  lastLabels = times.map(t=>{
    const d=new Date(t*1000);
    return (d.getMonth()+1)+"/"+d.getDate();
  });

  const latest = prices.at(-1);
  const prev   = prices.at(-2);


/* ===== æ¨ç®— ===== */

orukanEstimated = latest * ORUKAN_COEF;

const prevOrukan = prev * ORUKAN_COEF;

orukanDiff = orukanEstimated - prevOrukan;

orukanDiffPercent =
  (orukanDiff / prevOrukan) * 100;
  
  /* ===== ã‚ªãƒ«ã‚«ãƒ³å¤§è¡¨ç¤º ===== */

const orukanEl = document.getElementById("orukanInfo");

if(orukanEl && orukanEstimated !== null){

  const up = orukanDiff >= 0;

  const color = up ? "#00ff00" : "#ff0000";
  const arrow = up ? "â–²" : "â–¼";

const priceEl =
  orukanEl.querySelector(".orukanPrice");

const displayPrice =
  orukanEstimated.toFixed(0);

if(lastOrukan === null){

  priceEl.innerText =
    "æ¨ç®—ï½µï¾™ï½¶ï¾ " + displayPrice;

}else{

  let html = "æ¨ç®—ï½µï¾™ï½¶ï¾ ";
const prevPrice = lastOrukan.toFixed(0);
let diffIndex = -1;

// æœ€åˆã«å¤‰ã‚ã£ãŸæ¡ã‚’æ¢ã™
for(let i=0;i<displayPrice.length;i++){
  if(displayPrice[i] !== prevPrice[i]){
    diffIndex = i;
    break;
  }
}

for(let i=0;i<displayPrice.length;i++){

  const newChar = displayPrice[i];

  if(diffIndex !== -1 &&
     i >= diffIndex){

    html += `<span class="${
      orukanEstimated > lastOrukan
        ? "digitUp"
        : "digitDown"
    }">${newChar}</span>`;

  }else{
    html += newChar;
  }
}

  priceEl.innerHTML = html;
}

lastOrukan = orukanEstimated;
orukanEl.querySelector(".orukanChange").innerHTML =
  `<span class="fxChange" style="color:${color};">
   ${arrow}${Math.abs(orukanDiffPercent).toFixed(2)}%
   </span>`;
}
  
 
// ä»Šæ—¥ã®æ¨ç®—å€¤ã‚’ä¿å­˜

  const change = ((latest - prev) / prev) * 100;

  ac_price.innerHTML =
    latest.toFixed(0)+" å†† "+
    "<span style='color:"+(change>=0?"#00ff00":"#ff0000")+"'>"+
    (change>=0?"+":"")+change.toFixed(2)+"%</span>";

  stockUpdated.innerText =
    "UPD "+getNowTime();

  tickerStock =
    `2559.T ${latest.toFixed(0)}
     <span style="color:${change>=0?"#00ff00":"#ff0000"}">
     ${change>=0?"â–²":"â–¼"}${Math.abs(change).toFixed(2)}%</span>`;

if(orukanEstimated !== null){

let tickerOrukanPrice =
  orukanEstimated.toFixed(0);

let tickerOrukanHTML =
  tickerOrukanPrice;

if(lastTickerOrukan !== null){

  const prev =
    lastTickerOrukan.toFixed(0);

  let html = "";
  let diffIndex = -1;

  for(let i=0;i<tickerOrukanPrice.length;i++){
    if(tickerOrukanPrice[i] !== prev[i]){
      diffIndex = i;
      break;
    }
  }

  for(let i=0;i<tickerOrukanPrice.length;i++){

    const newChar =
      tickerOrukanPrice[i];

    if(diffIndex !== -1 &&
       i >= diffIndex){

      html += `<span class="${
        orukanEstimated > lastTickerOrukan
          ? "digitUp"
          : "digitDown"
      }">${newChar}</span>`;

    }else{
      html += newChar;
    }
  }

  tickerOrukanHTML = html;
}

lastTickerOrukan = orukanEstimated;

tickerStock +=
  ` â—† æ¨ç®—ï½µï¾™ï½¶ï¾ ${tickerOrukanHTML}
   <span style="color:${orukanDiff>=0?"#00ff00":"#ff0000"}">
   ${orukanDiff>=0?"â–²":"â–¼"}${Math.abs(orukanDiffPercent).toFixed(2)}%</span>`;
}

  updateTicker();

  chartData = prices;
  volumeData = volumes;

  setTimeout(()=>drawChart(),50);

 }catch(e){
  console.error(e);
  ac_price.innerText="æ ªä¾¡å–å¾—ã‚¨ãƒ©ãƒ¼";
  stockUpdated.innerText="ERROR "+getNowTime();
 }
}

function drawChart(){

 if(chartData.length < 2) return;

 const c = document.getElementById("chart");
 const ctx = c.getContext("2d");

 const dpr = window.devicePixelRatio || 1;
 const rect = c.getBoundingClientRect();

 c.width  = rect.width * dpr;
 c.height = rect.height * dpr;

 ctx.setTransform(1,0,0,1,0,0);
 ctx.scale(dpr,dpr);
 ctx.clearRect(0,0,rect.width,rect.height);

 const isLandscape =
   window.matchMedia("(orientation: landscape)").matches;

 /* ===== æ¨ªç”»é¢æœ€é©åŒ– ===== */
const padding = isLandscape ? 30 : 60;

 const w = rect.width - padding*2;
 const totalHeight = rect.height - padding*2;

 const priceHeight  = totalHeight * (isLandscape ? 0.65 : 0.7);
 const volumeHeight = totalHeight - priceHeight;

 const rawMax = Math.max(...chartData);
 const rawMin = Math.min(...chartData);

 const paddingRange = (rawMax - rawMin) * 0.1;
 const max = rawMax + paddingRange;
 const min = rawMin - paddingRange;
 const range = max - min || 1;

 ctx.fillStyle = "#ff9900";
 ctx.font = isLandscape ? "10px Arial" : "12px Arial";

 /* ===== æ¨ªç·š ===== */
 for(let i=0;i<=4;i++){
  const val = min + range*(i/4);
  const y = padding + priceHeight - (priceHeight*(i/4));

  ctx.strokeStyle = "#222";
  ctx.beginPath();
  ctx.moveTo(padding,y);
  ctx.lineTo(rect.width-padding,y);
  ctx.stroke();

  ctx.fillText(val.toFixed(0),1,y+3);
 }
 
 
 const baseGap = w/(chartData.length-1);
const gap = isLandscape ? baseGap * 0.98 : baseGap;
// æ¨ªç”»é¢ã§ä¸­å¤®å¯„ã›ã™ã‚‹ãŸã‚ã®é–‹å§‹Xè£œæ­£
const contentWidth = gap * (chartData.length - 1);
const offsetX = isLandscape ? (w - contentWidth) / 2 : 0;



 /* ===== ç¸¦ç·š + æ—¥ä»˜ ===== */
 lastLabels.forEach((lab,i)=>{
  const x = padding + offsetX + i*gap;

  ctx.strokeStyle="#181818";
  ctx.beginPath();
  ctx.moveTo(x,padding);
  ctx.lineTo(x,padding+priceHeight);
  ctx.stroke();

// iPhoneç¸¦åˆ¤å®š
const isIphone =
  /iPhone/.test(navigator.userAgent);

const isPortrait =
  window.innerHeight > window.innerWidth;

// iPhoneç¸¦ã®ã¨ãã ã‘æ—¥ä»˜ã‚’æã‹ãªã„
if(!(isIphone && isPortrait)){
  if(isLandscape || i%2===0){

    const labelOffset = isLandscape ? -10 : -15; 
    // â† -15 â†’ -10 ã«ã™ã‚‹ã¨ 5pxå³ã¸ç§»å‹•

    ctx.fillText(lab, x + labelOffset, rect.height-10);
  }
}
 });

 /* ===== æŠ˜ã‚Œç·š ===== */
 ctx.strokeStyle="#ff9900";
 ctx.lineWidth = 2;
 ctx.beginPath();

 chartData.forEach((v,i)=>{
  const x = padding + offsetX + i*gap;
  const y =
    padding + priceHeight -
    ((v-min)/range)*priceHeight;

  if(i===0) ctx.moveTo(x,y);
  else ctx.lineTo(x,y);
 });

 ctx.stroke();

 /* ===== å‡ºæ¥é«˜ ===== */
 const maxVolume = Math.max(...volumeData);

 volumeData.forEach((vol,i)=>{

  const barWidth = gap * (isLandscape ? 0.425 : 0.5);
  const x = padding + offsetX + i*gap - barWidth/2;

  const barHeight =
    (vol/maxVolume)*volumeHeight;

  const y =
    padding + priceHeight +
    (volumeHeight-barHeight);

  ctx.fillStyle =
    i>0 && chartData[i]>=chartData[i-1]
    ? "#00ff00"
    : "#ff0000";

  ctx.fillRect(x,y,barWidth,barHeight);
 });

}

function drawFXCandle(opens, highs, lows, closes){

  const canvas = document.getElementById("fxChart");
  const ctx = canvas.getContext("2d");

  const dpr = window.devicePixelRatio || 1;

  const rect = canvas.getBoundingClientRect();  // â† è¿½åŠ 

  canvas.width  = rect.width * dpr;             // â† å¤‰æ›´
  canvas.height = rect.height * dpr;            // â† å¤‰æ›´

  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr,dpr);


  const data = opens.map((o,i)=>({
    o:o,
    h:highs[i],
    l:lows[i],
    c:closes[i]
  })).filter(v =>
  v.o !== null &&
  v.h !== null &&
  v.l !== null &&
  v.c !== null
).slice(-40); // æœ€æ–°30æœ¬

  if(data.length < 2) return;

const padding = 20;
const w = rect.width - padding*2;
const fullHeight = rect.height - padding*2;

const isLandscape =
  window.matchMedia("(orientation: landscape)").matches;

const h = fullHeight * (isLandscape ? 1.28 : 1);  //ã‚·ãƒ«ã‚¯ã§ã¯1.28ã‚‚ã¨ã‚‚ã¨1.75

const yOffset = isLandscape ? -(h - fullHeight) * 0.52 : 0;

  const max = Math.max(...data.map(d=>d.h));
  const min = Math.min(...data.map(d=>d.l));
  const range = max - min || 1;

  const candleWidth = w / data.length * 0.6;
  const gap = w / data.length;

  data.forEach((d,i)=>{

    const x = padding + i*gap + gap/2;

const yHigh = padding + h - ((d.h - min)/range)*h + yOffset;
const yLow  = padding + h - ((d.l - min)/range)*h + yOffset;
const yOpen = padding + h - ((d.o - min)/range)*h + yOffset;
const yClose= padding + h - ((d.c - min)/range)*h + yOffset;

    const up = d.c >= d.o;

    ctx.strokeStyle = up ? "#00ff00" : "#ff0000";
    ctx.fillStyle   = up ? "#00ff00" : "#ff0000";

    // ãƒ’ã‚²
    ctx.beginPath();
    ctx.moveTo(x, yHigh);
    ctx.lineTo(x, yLow);
    ctx.stroke();

    // å®Ÿä½“
    const bodyTop = Math.min(yOpen, yClose);
    const bodyHeight = Math.abs(yClose - yOpen) || 1;

    ctx.fillRect(
      x - candleWidth/2,
      bodyTop,
      candleWidth,
      bodyHeight
    );

  });
}


window.addEventListener("resize",()=>{

  setTimeout(()=>{

    drawChart();   // æ ªãƒãƒ£ãƒ¼ãƒˆå†æç”»

    // â˜… FXãƒ­ãƒ¼ã‚½ã‚¯è¶³ã‚‚å†æç”»
    loadFX();      

  },100);   // iPhoneå¯¾ç­–ï¼ˆé«˜ã•ç¢ºå®šå¾…ã¡ï¼‰

});
loadStock();
setInterval(loadStock,600000);

/* ===== å¤©æ°—ï¼ˆGPSå¯¾å¿œï¼‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ===== */

function getWeatherIcon(code){
 if(code===0)return"â˜€ï¸";
 if(code===1)return"ğŸŒ¤";
 if(code===2)return"â›…";
 if(code===3)return"â˜ï¸";
 if(code>=45 && code<=48)return"ğŸŒ«";
 if(code>=51 && code<=57)return"ğŸŒ¦";
 if(code>=61 && code<=67)return"ğŸŒ§";
 if(code>=71 && code<=77)return"â„ï¸";
 if(code>=80 && code<=82)return"ğŸŒ§";
 if(code>=95)return"â›ˆ";
 return"â˜ï¸";
}

async function loadWeather(){

  if(!navigator.geolocation){
    loadDefaultWeather();
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos=>{
      loadWeatherByCoords(
        pos.coords.latitude,
        pos.coords.longitude,
        "ç¾åœ¨åœ°ï¼ˆä½ç²¾åº¦ï¼‰"
      );
    },
    ()=>{
      loadDefaultWeather();
    }
  );
}

function loadDefaultWeather(){
  // å¥ˆè‰¯çœŒç”Ÿé§’å¸‚ã‚ã™ã‹é‡å—
  loadWeatherByCoords(
    34.69,
    135.70,
    "å¥ˆè‰¯çœŒç”Ÿé§’å¸‚ã‚ã™ã‹é‡å—"
  );
}

async function loadWeatherByCoords(lat,lon,label){

 try{

  const url =
   `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo`;

  const res=await fetch(url);
  const j=await res.json();

  const week=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];

  const todayDate=new Date(j.daily.time[0]);
  const todayLabel=
   (todayDate.getMonth()+1)+"/"+
   todayDate.getDate()+
   "ï¼ˆ"+week[todayDate.getDay()]+"ï¼‰";

  weatherToday.innerHTML=
   `${label}<br>
   <span style="font-size:2.2em;">${getWeatherIcon(j.daily.weathercode[0])}</span> ${todayLabel}<br>
   æœ€é«˜æ°—æ¸© ${j.daily.temperature_2m_max[0]}â„ƒ<br>
   æœ€ä½æ°—æ¸© ${j.daily.temperature_2m_min[0]}â„ƒ<br>
   é™æ°´ç¢ºç‡ ${j.daily.precipitation_probability_max[0]}%`;

  let wk="";
  for(let i=1;i<7;i++){
   const d=new Date(j.daily.time[i]);
   const label2=
    (d.getMonth()+1)+"/"+
    d.getDate()+
    "ï¼ˆ"+week[d.getDay()]+"ï¼‰";

   wk+=`<div class='dailyItem'>
   ${getWeatherIcon(j.daily.weathercode[i])}
   ${label2}
   ${j.daily.temperature_2m_max[i]}â„ƒ /
   ${j.daily.temperature_2m_min[i]}â„ƒ
   ${j.daily.precipitation_probability_max[i]}%
   </div>`;
  }
  weatherWeekly.innerHTML=wk;

 }catch(e){
  weatherToday.innerText="å¤©æ°—å–å¾—ã‚¨ãƒ©ãƒ¼";
 }
}

loadWeather();
setInterval(loadWeather,3600000);

/* ===== ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼ˆå®Œå…¨åˆ†é›¢å‹ãƒ—ãƒ­ä»•æ§˜ï¼‰ ===== */

const alertWords = [
  "æ—¥éŠ€","å††å®‰","å††é«˜","åˆ©ä¸Šã’","åˆ©ä¸‹ã’",
  "æ ªå®‰","æ ªé«˜","ç‚ºæ›¿ä»‹å…¥","ã‚¤ãƒ³ãƒ•ãƒ¬",
  "ç±³å›½","FRB","é›‡ç”¨çµ±è¨ˆ","CPI","GDP",
  "FOMC","é•·æœŸé‡‘åˆ©","10å¹´å‚µ","ãƒ‰ãƒ«å††",
  "ç‚ºæ›¿","æ”¿ç­–é‡‘åˆ©","å›ºå®šé‡‘åˆ©","å¤‰å‹•é‡‘åˆ©",
"ä½å®…ãƒ­ãƒ¼ãƒ³","é‡‘åˆ©ä¸Šæ˜‡","é‡‘åˆ©å¼•ãä¸Šã’",
"é‡‘åˆ©å¼•ãä¸‹ã’","ç ´ç¶»","æŒ‡æ•°","ç±³","æ—¥æœ¬",
"çŸ­æœŸé‡‘åˆ©","å¤‰å‹•é‡‘åˆ©","æ—¥ç±³","éŠ€è¡Œ"
];

function highlightWords(text){
  alertWords.forEach(word=>{
    const reg = new RegExp(word,"g");
    text = text.replace(
      reg,
      `<span style="color:#ff0000;font-weight:bold;">${word}</span>`
    );
  });
  return text;
}

async function loadNews(){

  const generalURL =
   "https://api.rss2json.com/v1/api.json?rss_url=https://www.nhk.or.jp/rss/news/cat0.xml";

  const economyURL =
   "https://api.rss2json.com/v1/api.json?rss_url=https://www.nhk.or.jp/rss/news/cat5.xml";

  let generalItems = [];
  let economyItems = [];

  /* ===== ç·åˆãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾— ===== */
  try{
    const res = await fetch(generalURL);
    if(res.ok){
      const json = await res.json();
      if(Array.isArray(json.items)){
        generalItems = json.items;
      }
    }
  }catch(e){
    console.log("General news failed:", e);
  }

  /* ===== çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾— ===== */
  try{
    const res = await fetch(economyURL);
    if(res.ok){
      const json = await res.json();
      if(Array.isArray(json.items)){
        economyItems = json.items;
      }
    }
  }catch(e){
    console.log("Economy news failed:", e);
  }

 
    /* ===== æç”»å‡¦ç† ===== */

  newsGeneral.innerHTML = "";
  newsEconomy.innerHTML = "";

  let tickerCombined = "";

  /* --- ç·åˆ --- */
  if(generalItems.length){
    generalItems.slice(0,4).forEach(n=>{
      newsGeneral.innerHTML +=
        `<div class="newsItem">â–¶ ${highlightWords(n.title)}</div>`;
      tickerCombined += " â—† " + n.title;
    });
  }else{
    newsGeneral.innerHTML =
      `<div class="newsItem">ç·åˆãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—å¤±æ•—</div>`;
  }

  /* --- çµŒæ¸ˆ --- */
  if(economyItems.length){
    economyItems.slice(0,4).forEach(n=>{
      newsEconomy.innerHTML +=
        `<div class="newsItem">ğŸ’¹ ${highlightWords(n.title)}</div>`;
      tickerCombined += " â—† " + n.title;
    });
  }else{
    newsEconomy.innerHTML =
      `<div class="newsItem">çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—å¤±æ•—</div>`;
  }

  tickerNews = tickerCombined;
  updateTicker();
 newsUpdatedGeneral.innerText =
  "UPD " + getNowTime() ;

newsUpdatedEconomy.innerText =
  "UPD " + getNowTime(); 
}

loadNews();
setInterval(loadNews,352000);

/* ===== è‡ªå‹•ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åŒ–ï¼ˆFire TV / Silkå¯¾ç­–ï¼‰ ===== */

function enterFullscreen(){

  const el = document.documentElement;

  if(el.requestFullscreen){
    el.requestFullscreen();
  }else if(el.webkitRequestFullscreen){
    el.webkitRequestFullscreen();
  }

}

/* åˆå›ã‚¯ãƒªãƒƒã‚¯ã§å¿…ãšãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
document.addEventListener("click", enterFullscreen, {once:true});

/* å¿µã®ãŸã‚ãƒ­ãƒ¼ãƒ‰ç›´å¾Œã«ã‚‚è©¦è¡Œ */
window.addEventListener("load", ()=>{
  setTimeout(()=>{

    // æ“¬ä¼¼ã‚¯ãƒªãƒƒã‚¯ç™ºç«
    document.body.click();

  },1000);
});

/* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è§£é™¤ã•ã‚ŒãŸã‚‰å†çªå…¥ */
document.addEventListener("fullscreenchange", ()=>{
  if(!document.fullscreenElement){
    setTimeout(enterFullscreen,500);
  }
});


</script>
</body>
</html>
